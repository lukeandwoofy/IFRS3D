<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A330-200 Cesium Flight Simulator</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; }
        #cesiumContainer { width: 100%; height: 100%; }
        #login { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 100; }
        #hud { position: absolute; top: 10px; left: 10px; color: white; font-family: monospace; z-index: 100; }
    </style>
</head>
<body>
    <div id="login">
        <h1>A330-200 Flight Sim Login</h1>
        <form id="loginForm">
            <input type="password" id="password" placeholder="Enter password">
            <button type="submit">Login</button>
        </form>
    </div>
    <div id="cesiumContainer"></div>
    <div id="hud">
        <div>Speed: <span id="speed">0</span> knots</div>
        <div>Altitude: <span id="altitude">0</span> ft</div>
        <div>Heading: <span id="heading">0</span>Â°</div>
    </div>

    <script>
        const password = 'A330';
        const form = document.getElementById('loginForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (document.getElementById('password').value === password) {
                document.getElementById('login').style.display = 'none';
                initSim();
            } else {
                alert('Incorrect password');
            }
        });

        async function initSim() {
            Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5NDIwYmNkOS03MTExLTRjZGEtYjI0Yy01ZmIzYzJmOGFjNGEiLCJpZCI6MzM5NTE3LCJpYXQiOjE3NTczNTg4Mzd9.3gkVP8epIlHiy3MtC2GnDgLhvD4XbhfIsWfzuyYjDZQ'; // Replace with your token

            const viewer = new Cesium.Viewer('cesiumContainer', {
                terrain: Cesium.Terrain.fromWorldTerrain(),
            });
            viewer.scene.primitives.add(Cesium.createOsmBuildingsAsync());

            // Starting position: Near SFO runway (long, lat, alt in meters)
            let longitude = -122.375;
            let latitude = 37.619;
            let altitude = 100; // meters
            let heading = Cesium.Math.toRadians(0); // North
            let pitch = 0;
            let roll = 0;

            // Physics vars
            let velocity = 0; // forward speed m/s
            let verticalVelocity = 0;
            const gravity = 9.81 / 60; // approx per frame
            const liftFactor = 0.0005;
            const dragFactor = 0.0001;
            const thrust = 0.5; // adjustable
            let currentThrust = 0;

            // Load A330 model
            const airplaneUri = await Cesium.IonResource.fromAssetId(YOUR_ASSET_ID); // Replace with your asset ID
            const planeEntity = viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(longitude, latitude, altitude),
                model: {
                    uri: airplaneUri,
                    scale: 1.0, // Adjust if needed
                    minimumPixelSize: 128,
                },
                orientation: new Cesium.HeadingPitchRoll(heading, pitch, roll),
            });

            // Controls
            const keys = {};
            document.addEventListener('keydown', (e) => keys[e.key] = true);
            document.addEventListener('keyup', (e) => keys[e.key] = false);
            let viewMode = 'third'; // 'first' or 'third'

            // Animation loop
            viewer.clock.onTick.addEventListener(() => {
                // Update controls
                if (keys['w']) pitch = Math.max(pitch - 0.01, -Math.PI / 2); // Pitch up (negative for Cesium)
                if (keys['s']) pitch = Math.min(pitch + 0.01, Math.PI / 2); // Pitch down
                if (keys['a']) roll -= 0.01; // Roll left
                if (keys['d']) roll += 0.01; // Roll right
                if (keys['q']) heading -= 0.01; // Yaw left
                if (keys['e']) heading += 0.01; // Yaw right
                if (keys['ArrowUp']) currentThrust = Math.min(currentThrust + 0.01, 1);
                if (keys['ArrowDown']) currentThrust = Math.max(currentThrust - 0.01, 0);
                if (keys['v']) viewMode = viewMode === 'third' ? 'first' : 'third';

                // Dampen
                roll *= 0.98;
                pitch *= 0.98;

                // Physics
                velocity += currentThrust * thrust - velocity * dragFactor;
                verticalVelocity += Math.sin(pitch) * velocity * liftFactor - gravity;
                const distance = velocity / 3600; // degrees per frame (approx for equator)
                longitude += Math.cos(heading) * distance * Math.cos(pitch);
                latitude += Math.sin(heading) * distance * Math.cos(pitch);
                altitude += verticalVelocity;

                // Terrain collision (sample height and clamp)
                Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, [Cesium.Cartographic.fromDegrees(longitude, latitude)]).then((samples) => {
                    const terrainHeight = samples[0].height || 0;
                    altitude = Math.max(altitude, terrainHeight + 10); // 10m buffer
                });

                // Update plane
                planeEntity.position = Cesium.Cartesian3.fromDegrees(longitude, latitude, altitude);
                planeEntity.orientation = Cesium.Transforms.headingPitchRollQuaternion(
                    planeEntity.position,
                    new Cesium.HeadingPitchRoll(heading, pitch, roll)
                );

                // Camera views
                if (viewMode === 'third') {
                    viewer.camera.lookAt(planeEntity.position, new Cesium.HeadingPitchRange(heading, -Cesium.Math.PI_OVER_FOUR, 500));
                } else {
                    // First-person: Offset forward in cockpit
                    const offset = new Cesium.Cartesian3(0, 0, 5); // Adjust
                    const transform = Cesium.Matrix4.fromRotationTranslation(Cesium.Transforms.headingPitchRollToFixedFrame(planeEntity.position, new Cesium.HeadingPitchRoll(heading, pitch, roll)), offset);
                    viewer.camera.lookAtTransform(transform, new Cesium.HeadingPitchRange(0, 0, 0));
                }

                // Update HUD (convert to knots, ft)
                document.getElementById('speed').textContent = Math.round(velocity * 1.944); // m/s to knots
                document.getElementById('altitude').textContent = Math.round(altitude * 3.281); // m to ft
                document.getElementById('heading').textContent = Math.round(Cesium.Math.toDegrees(heading) % 360);
            });
        }
    </script>
</body>
</html>
